name: ASC-1.3 Integrity
# Authority: Avant Systems Canon (Clause 8)
# Target: Physical Compute Node (Trashcan)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  merge_group:
    types: [checks_requested]

jobs:
  governance:
    name: Governance Check
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Verify Codeowners
        run: |
          if [ ! -f .github/CODEOWNERS ]; then
            echo "::error::CODEOWNERS file missing. Violation of Tier 0 Governance."
            exit 1
          fi

  system-integrity:
    name: Nix Flake Verification
    runs-on: self-hosted
    needs: governance
    steps:
      - uses: actions/checkout@v4
      
      # [NEW] Inject Synthetic Identity for CI Context
      - name: Inject CI Identity
        run: echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAACI_DUMMY_KEY_FOR_CI_CHECK_ONLY ci@tarantula' > hosts/trashcan/admin.keys
        
      - name: Hardware Syntax Check
        run: nix flake check --show-trace