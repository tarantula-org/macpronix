name: ASC-1.3 Integrity
# Authority: Avant Systems Canon (Clause 8)
# Target: Physical Compute Node (Trashcan)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  governance:
    name: Governance Check
    runs-on: [self-hosted, linux, x64] # <--- THE CRITICAL SHIFT
    steps:
      - uses: actions/checkout@v4
      - name: Verify Codeowners
        run: |
          if [ ! -f .github/CODEOWNERS ]; then
            echo "::error::CODEOWNERS file missing. Violation of Tier 0 Governance."
            exit 1
          fi

  system-integrity:
    name: Nix Flake Verification
    runs-on: [self-hosted, linux, x64] # <--- THE CRITICAL SHIFT
    needs: governance
    steps:
      - uses: actions/checkout@v4
      
      # The Trashcan already has Nix installed natively. 
      # We don't need the installer action, just the command.
      
      - name: Hardware Syntax Check
        run: nix flake check --show-trace
        
      - name: Dry-Run Build (Smoke Test)
        run: |
          echo "::group::Simulating System Rebuild"
          nix build .#nixosConfigurations.trashcan.config.system.build.toplevel --dry-run
          echo "::endgroup::"