#!/usr/bin/env bash

# ==============================================================================
#  MACPRONIX // CLUSTER CONTROLLER
#  v3.1 "Cobalt Prime"
# ==============================================================================

# -- PALETTE --
# High-Contrast Neon for TTY readability
RED='\033[38;5;196m'
GREEN='\033[38;5;46m'
CYAN='\033[38;5;51m'
BLUE='\033[38;5;33m'
GREY='\033[38;5;240m'
NC='\033[0m'

# -- CONFIGURATION --
REPO_ROOT="$HOME/macpronix"
RUNNER_CONFIG="$REPO_ROOT/hosts/trashcan/runner.nix"
VERSION_FILE="$REPO_ROOT/VERSION.txt"

# [SYSTEMS ENGINEERING] DYNAMIC DETECTION
# Scans kernel device tree for the Broadcom chipset
WIFI_IFACE=$(ls /sys/class/net/ | grep -E '^wl' | head -n 1)
[ -z "$WIFI_IFACE" ] && WIFI_IFACE="wlan0"

# Fetch Version
if [ -f "$VERSION_FILE" ]; then
    VERSION=$(cat "$VERSION_FILE")
else
    VERSION="DEV"
fi

# -- VISUALS --

banner() {
    clear
    echo -e "${BLUE}"
    # "Slant" Font - Cyberpunk Industrial
    cat << "EOF"
███╗   ███╗ █████╗  ██████╗██████╗ ██████╗  ██████╗ ███╗   ██╗██╗██╗  ██╗
████╗ ████║██╔══██╗██╔════╝██╔══██╗██╔══██╗██╔═══██╗████╗  ██║██║╚██╗██╔╝
██╔████╔██║███████║██║     ██████╔╝██████╔╝██║   ██║██╔██╗ ██║██║ ╚███╔╝ 
██║╚██╔╝██║██╔══██║██║     ██╔═══╝ ██╔══██╗██║   ██║██║╚██╗██║██║ ██╔██╗ 
██║ ╚═╝ ██║██║  ██║╚██████╗██║     ██║  ██║╚██████╔╝██║ ╚████║██║██╔╝ ██╗
╚═╝     ╚═╝╚═╝  ╚═╝ ╚═════╝╚═╝     ╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝╚═╝╚═╝  ╚═╝
EOF
    echo -e "${NC}"
    echo -e "   ${CYAN}:: CLUSTER NODE CONTROLLER ::${NC}   ${GREY}v${VERSION}${NC}"
    echo ""
}

# -- LOGIC --

cmd_status() {
    banner
    echo -e "${BLUE}┌──[ SYSTEM TELEMETRY ]─────────────────────────────────────┐${NC}"
    
    # 1. RUNNER
    echo -n -e "${BLUE}│${NC} Runner Node: "
    if systemctl is-active --quiet github-runner-trashcan-worker; then
        echo -e "${GREEN}● ONLINE${NC}"
        CURRENT_ORG=$(grep 'url =' "$RUNNER_CONFIG" | cut -d '"' -f 2)
        echo -e "${BLUE}│${NC} Target Org:  ${CYAN}$CURRENT_ORG${NC}"
    else
        echo -e "${RED}● OFFLINE${NC}"
    fi

    echo -e "${BLUE}│${NC}"

    # 2. TAILSCALE
    echo -n -e "${BLUE}│${NC} Tailscale:   "
    TS_IP=$(tailscale ip -4 2>/dev/null)
    if [ ! -z "$TS_IP" ]; then
        echo -e "${GREEN}● ACTIVE${NC} ${GREY}($TS_IP)${NC}"
    else
        echo -e "${RED}● DISCONNECTED${NC}"
    fi

    # 3. WIFI (Robust Parsing)
    echo -n -e "${BLUE}│${NC} Uplink:      "
    
    if [ ! -d "/sys/class/net/$WIFI_IFACE" ]; then
        echo -e "${RED}● NO DEVICE${NC}"
    else
        # Check connection state
        LINK=$(iwctl station $WIFI_IFACE show 2>/dev/null | grep "Connected network" | awk '{print $3}')
        
        if [ ! -z "$LINK" ]; then
            # Parse signal strength. 
            # grep finds the line, awk gets 3rd column ("50."), tr removes the dot.
            RAW_QUALITY=$(grep "$WIFI_IFACE" /proc/net/wireless | awk '{print $3}' | tr -d '.')
            
            # Math: Convert raw quality (0-70) to Percentage (0-100)
            if [[ "$RAW_QUALITY" =~ ^[0-9]+$ ]]; then
                QUALITY=$(( (RAW_QUALITY * 100) / 70 ))
                echo -e "${GREEN}● CONNECTED${NC} ${GREY}($LINK - ${QUALITY}%)${NC}"
            else
                echo -e "${GREEN}● CONNECTED${NC} ${GREY}($LINK - ?% Signal)${NC}"
            fi
        else
             echo -e "${RED}● NO LINK${NC} ${GREY}($WIFI_IFACE idle)${NC}"
        fi
    fi
    echo -e "${BLUE}└───────────────────────────────────────────────────────────┘${NC}"
    echo ""
}

cmd_set_org() {
    NEW_URL=$1
    if [ -z "$NEW_URL" ]; then
        echo -e "${RED}Error: Usage macpronix set-org <URL>${NC}"
        return
    fi
    echo -e "${CYAN}:: RE-TARGETING CLUSTER ::${NC}"
    echo -e "New Target: ${BLUE}$NEW_URL${NC}"
    sed -i "s|url = \".*\";|url = \"$NEW_URL\";|" "$RUNNER_CONFIG"
    echo -e "${GREEN}✓ Configuration updated.${NC}"
    echo -e "${GREY}Run 'macpronix sync' to apply changes.${NC}"
}

cmd_sync() {
    echo -e "${CYAN}:: INITIATING STATE SYNC ::${NC}"
    cd "$REPO_ROOT"
    
    echo -e "${GREY}[1/3] Secure Pull (Stashing Changes)...${NC}"
    
    # [SYSTEMS ENGINEERING] The "Dirty Tree" Fix
    # 1. Stash EVERYTHING (including new/untracked files)
    # 2. Pull upstream (Force Rebase)
    # 3. Restore local changes
    git stash push --include-untracked -m "macpronix-sync-auto" --quiet
    git pull --rebase
    git stash pop --quiet 2>/dev/null || true
    
    echo -e "${GREY}[2/3] Resolving Permissions...${NC}"
    # Fix ownership if root messed it up during previous builds
    sudo chown -R $USER . 2>/dev/null || true
    
    echo -e "${GREY}[3/3] Rebuilding System...${NC}"
    sudo nixos-rebuild switch --flake .#trashcan
    
    echo -e "${GREEN}✓ SYSTEM SYNCED${NC}"
}

cmd_upgrade() {
    echo -e "${CYAN}:: SYSTEM UPGRADE ::${NC}"
    cd "$REPO_ROOT"
    
    echo -e "${GREY}[*] Updating Flake Inputs...${NC}"
    nix flake update
    
    echo -e "${GREY}[*] Rebuilding...${NC}"
    sudo nixos-rebuild switch --flake .#trashcan
    
    echo -e "${GREEN}✓ UPGRADE COMPLETE${NC}"
}

cmd_help() {
    banner
    echo -e "Usage: ${CYAN}macpronix${NC} [COMMAND]"
    echo ""
    echo -e "  ${BLUE}status${NC}     Show dashboard telemetry."
    echo -e "  ${BLUE}sync${NC}       Stash local changes, pull git & rebuild."
    echo -e "  ${BLUE}upgrade${NC}    Update lockfile & rebuild."
    echo -e "  ${BLUE}edit${NC}       Open config in Neovim."
    echo -e "  ${BLUE}set-org${NC}    Change GitHub Target."
    echo ""
}

# -- ROUTER --

case "$1" in
    status) cmd_status ;;
    sync) cmd_sync ;;
    upgrade) cmd_upgrade ;;
    set-org) cmd_set_org "$2" ;;
    edit) cd "$REPO_ROOT"; nvim . ;;
    help|--help|-h) cmd_help ;;
    *) cmd_help ;;
esac