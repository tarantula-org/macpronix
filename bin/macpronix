#!/usr/bin/env bash
# ==============================================================================
#  MACPRONIX // CLUSTER CONTROLLER
# ==============================================================================

set -euo pipefail

# -- CONFIGURATION --
REPO_ROOT="$HOME/macpronix"
VERSION="5.1.0"

# -- PALETTE --
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
GREY='\033[0;90m'
NC='\033[0m'

# -- UTILS --
log_info()    { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC}   $1"; }
log_warn()    { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error()   { echo -e "${RED}[ERR]${NC}  $1"; }

die() {
    log_error "$1"
    exit 1
}

banner() {
    clear
    echo -e "${BLUE}"
    cat << "EOF"
   __  __          _____ _____  _____   ____  _   _ _______   __
  |  \/  |   /\   / ____|  __ \|  __ \ / __ \| \ | |_   _\ \ / /
  | \  / |  /  \ | |    | |__) | |__) | |  | |  \| | | |  \ V / 
  | |\/| | / /\ \| |    |  ___/|  _  /| |  | | . ` | | |   > <  
  | |  | |/ ____ \ |____| |    | | \ \| |__| | |\  |_| |_ / . \ 
  |_|  |_/_/    \_\_____|_|    |_|  \_\\____/|_| \_|_____/_/ \_\
EOF
    echo -e "${NC}"
    echo -e "   ${CYAN}:: CLUSTER CONTROLLER ::${NC}   v${VERSION}"
    echo -e "   ${GREY}Node: $(hostname)${NC}"
    echo ""
}

# -- CORE LOGIC --

cmd_sync() {
    log_info "Initiating synchronization..."
    cd "$REPO_ROOT" || die "Repository not found at $REPO_ROOT"

    # 1. FETCH & RESET
    # Enforce remote state as the single source of truth.
    log_info "Fetching upstream..."
    git fetch origin

    if ! git reset --hard origin/main; then
        die "Git reset failed. Check network."
    fi

    # 2. CLEANUP
    # Remove untracked files to prevent lockfile drift.
    git clean -fd

    # 3. VACCINE
    # Normalize line endings for Nix evaluator.
    find . -type f -name "*.nix" -exec sed -i 's/\r$//' {} + 2>/dev/null || true
    chmod +x bin/macpronix

    # 4. DEPLOY
    # Delegate to Makefile for hardware injection and build.
    log_info "Injecting hardware config and building..."
    make install
}

cmd_upgrade() {
    log_info "Upgrading system dependencies..."
    cd "$REPO_ROOT" || die "Repository not found"
    nix flake update
    log_success "Flake updated. Commit 'flake.lock' to push to fleet."
}

cmd_status() {
    banner
    echo -e "${BLUE}┌──[ NODE TELEMETRY ]───────────────────────────────────────┐${NC}"
    
    echo -n -e "${BLUE}│${NC} CI Runner:   "
    if systemctl is-active --quiet "github-runner-trashcan-worker"; then
        echo -e "${GREEN}● ONLINE${NC}"
    else
        echo -e "${RED}● OFFLINE${NC}"
    fi

    echo -n -e "${BLUE}│${NC} Tailscale:   "
    if TS_IP=$(tailscale ip -4 2>/dev/null); then
        echo -e "${GREEN}● $TS_IP${NC}"
    else
        echo -e "${GREY}○ Disconnected${NC}"
    fi

    echo -n -e "${BLUE}│${NC} WiFi (NM):   "
    if NM_SSID=$(nmcli -t -f active,ssid dev wifi | grep '^yes' | cut -d: -f2); then
        echo -e "${GREEN}● $NM_SSID${NC}"
    else
        echo -e "${GREY}○ Disconnected${NC}"
    fi
    
    echo -e "${BLUE}└───────────────────────────────────────────────────────────┘${NC}"
    echo ""
}

# -- MAIN --

case "${1:-help}" in
    sync)    cmd_sync ;;
    upgrade) cmd_upgrade ;;
    status)  cmd_status ;;
    help|*)  
        banner
        echo "Usage: macpronix {sync|upgrade|status}" 
        ;;
esac