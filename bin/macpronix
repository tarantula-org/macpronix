#!/usr/bin/env bash

# ==============================================================================
#  MACPRONIX // CLUSTER CONTROLLER
#  v2.3 "Cobalt Trashcan"
# ==============================================================================

# -- PALETTE (Blue/Cyan Theme) --
RED='\033[38;5;196m'
GREEN='\033[38;5;46m'
CYAN='\033[38;5;51m'    # Electric Cyan
BLUE='\033[38;5;33m'    # Deep Blue
GREY='\033[38;5;240m'
NC='\033[0m'

# -- CONFIGURATION --
REPO_ROOT="$HOME/macpronix"
RUNNER_CONFIG="$REPO_ROOT/hosts/trashcan/runner.nix"

# [SYSTEMS ENGINEERING] DYNAMIC HARDWARE DETECTION
# Scans the kernel device tree for the first wireless interface
WIFI_IFACE=$(ls /sys/class/net/ | grep -E '^wl' | head -n 1)

# Fallback if detection fails (e.g. no driver loaded)
if [ -z "$WIFI_IFACE" ]; then
    WIFI_IFACE="wlan0"
fi

# -- VISUALS --

banner() {
    clear
    echo -e "${BLUE}"
    cat << "EOF"
    __  __
   /_/  \_\
    _\/\/_
 /\_\_\/_/_/\
 \/ /_/\_\ \/
   __/\/\__
   \_\  /_/
EOF
    echo -e "${NC}"
    echo -e "   ${CYAN}:: TRASHCAN CLUSTER CONTROLLER ::${NC}   ${GREY}v2.3${NC}"
    echo ""
}

# -- LOGIC --

cmd_status() {
    banner
    echo -e "${BLUE}┌──[ SYSTEM TELEMETRY ]─────────────────────────────────────┐${NC}"
    
    # 1. RUNNER CHECK
    echo -n -e "${BLUE}│${NC} Runner Node: "
    if systemctl is-active --quiet github-runner-trashcan-worker; then
        echo -e "${GREEN}● ONLINE${NC}"
        CURRENT_ORG=$(grep 'url =' "$RUNNER_CONFIG" | cut -d '"' -f 2)
        echo -e "${BLUE}│${NC} Target Org:  ${CYAN}$CURRENT_ORG${NC}"
    else
        echo -e "${RED}● OFFLINE${NC}"
    fi

    echo -e "${BLUE}│${NC}"

    # 2. NETWORK CHECK
    echo -n -e "${BLUE}│${NC} Tailscale:   "
    TS_IP=$(tailscale ip -4 2>/dev/null)
    if [ ! -z "$TS_IP" ]; then
        echo -e "${GREEN}● ACTIVE${NC} ${GREY}($TS_IP)${NC}"
    else
        echo -e "${RED}● DISCONNECTED${NC}"
    fi

    # 3. WIFI CHECK (Auto-Detected)
    echo -n -e "${BLUE}│${NC} Uplink:      "
    
    # Check if interface exists
    if [ ! -d "/sys/class/net/$WIFI_IFACE" ]; then
        echo -e "${RED}● NO DEVICE${NC} ${GREY}(No wireless card found)${NC}"
    else
        LINK=$(iwctl station $WIFI_IFACE show 2>/dev/null | grep "Connected network" | awk '{print $3}')
        if [ ! -z "$LINK" ]; then
            QUALITY=$(grep "$WIFI_IFACE" /proc/net/wireless | awk '{print int($3 * 100 / 70)}')
            echo -e "${GREEN}● CONNECTED${NC} ${GREY}($LINK - ${QUALITY}% Signal on $WIFI_IFACE)${NC}"
        else
             echo -e "${RED}● NO LINK${NC} ${GREY}($WIFI_IFACE idle)${NC}"
        fi
    fi
    echo -e "${BLUE}└───────────────────────────────────────────────────────────┘${NC}"
    echo ""
}

cmd_set_org() {
    NEW_URL=$1
    if [ -z "$NEW_URL" ]; then
        echo -e "${RED}Error: Usage macpronix set-org <URL>${NC}"
        return
    fi
    echo -e "${CYAN}:: RE-TARGETING CLUSTER ::${NC}"
    echo -e "New Target: ${BLUE}$NEW_URL${NC}"
    sed -i "s|url = \".*\";|url = \"$NEW_URL\";|" "$RUNNER_CONFIG"
    echo -e "${GREEN}✓ Configuration updated.${NC}"
    echo -e "${GREY}Run 'macpronix sync' to apply changes.${NC}"
}

cmd_sync() {
    echo -e "${CYAN}:: INITIATING STATE SYNC ::${NC}"
    cd "$REPO_ROOT"
    echo -e "${GREY}[1/3] Pulling Manifests...${NC}"
    git pull
    echo -e "${GREY}[2/3] Resolving Dependencies...${NC}"
    echo -e "${GREY}[3/3] Rebuilding System...${NC}"
    sudo nixos-rebuild switch --flake .#trashcan
    echo -e "${GREEN}✓ SYSTEM SYNCED${NC}"
}

cmd_upgrade() {
    echo -e "${CYAN}:: SYSTEM UPGRADE ::${NC}"
    cd "$REPO_ROOT"
    nix flake update
    sudo nixos-rebuild switch --flake .#trashcan
}

cmd_help() {
    banner
    echo -e "Usage: ${CYAN}macpronix${NC} [COMMAND]"
    echo ""
    echo -e "  ${BLUE}status${NC}     Show dashboard telemetry and network health."
    echo -e "  ${BLUE}sync${NC}       Pull latest git changes and rebuild the system."
    echo -e "  ${BLUE}upgrade${NC}    Update flake inputs (lockfile) and rebuild."
    echo -e "  ${BLUE}edit${NC}       Open the configuration repository in Neovim."
    echo -e "  ${BLUE}set-org${NC}    Change the GitHub Organization target."
    echo -e "  ${BLUE}help${NC}       Show this help message."
    echo ""
}

# -- ROUTER --

case "$1" in
    status) cmd_status ;;
    sync) cmd_sync ;;
    upgrade) cmd_upgrade ;;
    set-org) cmd_set_org "$2" ;;
    edit) cd "$REPO_ROOT"; nvim . ;;
    help|--help|-h) cmd_help ;;
    *) cmd_help ;;
esac