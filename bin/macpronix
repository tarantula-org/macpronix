#!/usr/bin/env bash
# ==============================================================================
#  MACPRONIX // CLUSTER CONTROLLER
#  v4.0.0 "Industrial Standard"
# ==============================================================================

# [STRICT MODE]
# -e: Exit immediately on error
# -u: Exit on undefined variables
# -o pipefail: Exit if any part of a pipe fails
set -euo pipefail

# -- CONFIGURATION --
REPO_ROOT="$HOME/macpronix"
VERSION_FILE="$REPO_ROOT/VERSION.txt"
STASH_NAME="macpronix-autosync-$(date +%s)"

# -- PALETTE --
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
GREY='\033[0;90m'
NC='\033[0m'

# -- UTILS --

log_info()  { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success(){ echo -e "${GREEN}[OK]${NC}   $1"; }
log_warn()  { echo -e "${CYAN}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERR]${NC}  $1"; }

die() {
    log_error "$1"
    exit 1
}

# -- TRAP HANDLER --
# This function runs automatically if the script crashes or you Ctrl+C
cleanup() {
    EXIT_CODE=$?
    if [ $EXIT_CODE -ne 0 ]; then
        echo ""
        log_warn "Script interrupted or failed (Code: $EXIT_CODE)."
        
        # Check if we left a stash behind
        if git stash list | grep -q "$STASH_NAME"; then
            log_warn "Restoring your local changes from stash..."
            git stash pop --quiet >/dev/null || log_error "Could not auto-restore stash. Run 'git stash pop' manually."
        fi
    fi
}
trap cleanup EXIT INT TERM

# -- CORE LOGIC --

detect_identity() {
    # 1. Hostname
    TARGET_HOST=$(hostname)
    
    # 2. Config File
    if [ -d "$REPO_ROOT/hosts/$TARGET_HOST" ]; then
        RUNNER_CONFIG="$REPO_ROOT/hosts/$TARGET_HOST/runner.nix"
    else
        RUNNER_CONFIG="$REPO_ROOT/hosts/trashcan/runner.nix"
    fi
}

banner() {
    clear
    echo -e "${BLUE}"
    cat << "EOF"
   __  __          _____ _____  _____   ____  _   _ _______   __
  |  \/  |   /\   / ____|  __ \|  __ \ / __ \| \ | |_   _\ \ / /
  | \  / |  /  \ | |    | |__) | |__) | |  | |  \| | | |  \ V / 
  | |\/| | / /\ \| |    |  ___/|  _  /| |  | | . ` | | |   > <  
  | |  | |/ ____ \ |____| |    | | \ \| |__| | |\  |_| |_ / . \ 
  |_|  |_/_/    \_\_____|_|    |_|  \_\\____/|_| \_|_____/_/ \_\
EOF
    echo -e "${NC}"
    echo -e "   ${CYAN}:: CLUSTER CONTROLLER ::${NC}   v4.0"
    echo -e "   ${GREY}ID: ${TARGET_HOST}${NC}"
    echo ""
}

cmd_sync() {
    log_info "Initiating Sync Protocol..."
    
    cd "$REPO_ROOT" || die "Could not find repository at $REPO_ROOT"

    # 1. State Protection
    if [[ -n $(git status --porcelain) ]]; then
        log_warn "Dirty tree detected. Stashing changes..."
        git stash push --include-untracked -m "$STASH_NAME" --quiet
    else
        log_info "Tree is clean."
    fi

    # 2. Update
    log_info "Pulling from origin..."
    if ! git pull --rebase; then
        die "Git pull failed. Fix conflicts manually."
    fi

    # 3. Build
    log_info "Rebuilding System (.#${TARGET_HOST})..."
    log_warn "If this hangs at 'restarting polkit', wait 30s."
    
    if sudo nixos-rebuild switch --flake ".#${TARGET_HOST}" --show-trace; then
        echo ""
        log_success "Build Complete."
    else
        echo ""
        die "NixOS Build Failed. System not updated."
    fi
    
    # 4. Restoration (Trap handles failure, we handle success)
    if git stash list | grep -q "$STASH_NAME"; then
        log_info "Restoring local changes..."
        git stash pop --quiet >/dev/null
    fi

    log_success "SYSTEM SYNCED SUCCESSFULLY"
}

cmd_status() {
    banner
    echo -e "${BLUE}┌──[ TELEMETRY ]────────────────────────────────────────────┐${NC}"
    
    # Runner Check
    echo -n -e "${BLUE}│${NC} CI Runner:   "
    if systemctl is-active --quiet "github-runner-${TARGET_HOST}-worker" || \
       systemctl is-active --quiet "github-runner-trashcan-worker"; then
        echo -e "${GREEN}● ONLINE${NC}"
    else
        echo -e "${RED}● OFFLINE${NC}"
    fi

    # Network
    TS_IP=$(tailscale ip -4 2>/dev/null || echo "N/A")
    echo -e "${BLUE}│${NC} Tailscale:   ${GREY}$TS_IP${NC}"
    
    echo -e "${BLUE}└───────────────────────────────────────────────────────────┘${NC}"
    echo ""
}

# -- MAIN ROUTER --

detect_identity

case "${1:-help}" in
    sync)   cmd_sync ;;
    status) cmd_status ;;
    help)
        banner
        echo "Usage: macpronix {sync|status}"
        ;;
    *)
        die "Unknown command: $1"
        ;;
esac